{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–π–¥–∂–∞–º–∏ - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title">
            <i class="fas fa-medal text-warning me-2 glow-effect"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–π–¥–∂–∞–º–∏
        </h2>
        <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>–ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
        </a>
    </div>

    <!-- Create Badge Form -->
    <div class="admin-form-card mb-4">
        <h4 class="text-warning mb-3">
            <i class="fas fa-plus-circle me-2"></i>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –±–µ–π–¥–∂
        </h4>
        <form method="POST" action="{{ url_for('create_badge') }}">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label required">–°–∏—Å—Ç–µ–º–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-control" name="name" required
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: champion_badge">
                    <div class="form-text">–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label required">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-control" name="display_name" required
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß–µ–º–ø–∏–æ–Ω">
                </div>
                <div class="col-12">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea class="form-control" name="description" rows="2"
                              placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –±–µ–π–¥–∂–∞"></textarea>
                </div>
                <div class="col-md-4">
                    <label class="form-label">–ò–∫–æ–Ω–∫–∞ (Font Awesome)</label>
                    <input type="text" class="form-control" name="icon" value="fas fa-medal"
                           placeholder="fas fa-medal">
                </div>
                <div class="col-md-4">
                    <label class="form-label">–≠–º–æ–¥–∑–∏ (—Ç–µ–∫—Å—Ç)</label>
                    <input type="text" class="form-control" name="emoji"
                           placeholder="üèÜ" maxlength="10">
                </div>
                <div class="col-md-4">
                    <label class="form-label">–ö–∞—Å—Ç–æ–º–Ω—ã–π —ç–º–æ–¥–∑–∏ (URL)</label>
                    <input type="text" class="form-control" name="emoji_url"
                           placeholder="https://example.com/emoji.png">
                </div>
                <div class="col-md-4">
                    <label class="form-label">–†–µ–¥–∫–æ—Å—Ç—å</label>
                    <select class="form-select" name="rarity">
                        <option value="common">–û–±—ã—á–Ω—ã–π</option>
                        <option value="rare">–†–µ–¥–∫–∏–π</option>
                        <option value="epic">–≠–ø–∏—á–µ—Å–∫–∏–π</option>
                        <option value="legendary">–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π</option>
                        <option value="mythic">–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
                    <input type="color" class="form-control form-control-color" name="color" value="#ffffff">
                </div>
                <div class="col-md-6">
                    <label class="form-label">–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label>
                    <input type="color" class="form-control form-control-color" name="background_color" value="#343a40">
                </div>
                <div class="col-md-6">
                    <label class="form-label">–¶–≤–µ—Ç —Ä–∞–º–∫–∏</label>
                    <input type="color" class="form-control form-control-color" name="border_color" value="#ffd700">
                </div>
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="has_gradient" id="hasGradient">
                        <label class="form-check-label" for="hasGradient">
                            –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –±–µ–π–¥–∂
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_animated" id="isAnimated">
                        <label class="form-check-label" for="isAnimated">
                            –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–µ–π–¥–∂
                        </label>
                    </div>
                </div>
                <div class="col-md-6" id="gradientStart" style="display: none;">
                    <label class="form-label">–ù–∞—á–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞</label>
                    <input type="color" class="form-control form-control-color" name="gradient_start" value="#ffc107">
                </div>
                <div class="col-md-6" id="gradientEnd" style="display: none;">
                    <label class="form-label">–ö–æ–Ω–µ—á–Ω—ã–π —Ü–≤–µ—Ç –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞</label>
                    <input type="color" class="form-control form-control-color" name="gradient_end" value="#ff9800">
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –±–µ–π–¥–∂
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Assign Badge Form -->
    <div class="admin-form-card mb-4">
        <h4 class="text-info mb-3">
            <i class="fas fa-user-plus me-2"></i>–ü—Ä–∏—Å–≤–æ–∏—Ç—å –±–µ–π–¥–∂ –∏–≥—Ä–æ–∫—É
        </h4>
        <form method="POST" action="{{ url_for('assign_badge') }}">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label required">–ò–≥—Ä–æ–∫</label>
                    <select class="form-select" name="player_id" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞</option>
                        {% for player in players %}
                        <option value="{{ player.id }}">{{ player.nickname }} (–£—Ä–æ–≤–µ–Ω—å {{ player.level }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label required">–ë–µ–π–¥–∂</label>
                    <select class="form-select" name="badge_id" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–µ–π–¥–∂</option>
                        {% for stat in badge_stats %}
                        {% if stat.badge.is_active %}
                        <option value="{{ stat.badge.id }}">{{ stat.badge.display_name }} ({{ stat.assigned_count }} –∏–≥—Ä–æ–∫–æ–≤)</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-plus me-2"></i>–ü—Ä–∏—Å–≤–æ–∏—Ç—å –±–µ–π–¥–∂
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Existing Badges -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –±–µ–π–¥–∂–∏ ({{ badges|length }})
                </h5>
            </div>
            <div class="card-body">
                {% if badges and badges|length > 0 %}
                    <div class="row">
                        {% for badge in badges %}
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="badge-preview-card">
                                <div class="badge-display {% if badge.is_animated %}badge-animated{% endif %}" 
                                     style="{% if badge.has_gradient and badge.gradient_start and badge.gradient_end %}background: linear-gradient(45deg, {{ badge.gradient_start }}, {{ badge.gradient_end }});{% else %}background-color: {{ badge.background_color }};{% endif %} color: {{ badge.color }}; border: 2px solid {{ badge.border_color }};">
                                    {% if badge.display_emoji %}
                                        {{ badge.display_emoji|safe }}
                                    {% elif badge.emoji %}
                                        {{ badge.emoji }}
                                    {% elif badge.emoji_class %}
                                        <i class="{{ badge.emoji_class }}"></i>
                                    {% else %}
                                        <i class="{{ badge.icon }}"></i>
                                    {% endif %}
                                    <span class="ms-2">{{ badge.display_name }}</span>
                                </div>
                                <div class="badge-info">
                                    <strong>{{ badge.display_name }}</strong>
                                    <small class="text-muted d-block">{{ badge.description or '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è' }}</small>
                                    <div class="badge-meta mt-2">
                                        <span class="badge bg-{{ 'primary' if badge.rarity == 'common' else 'success' if badge.rarity == 'uncommon' else 'warning' if badge.rarity == 'rare' else 'danger' if badge.rarity == 'epic' else 'info' if badge.rarity == 'legendary' else 'dark' }} me-1">{{ badge.rarity.title() }}</span>
                                        <span class="text-muted">{{ badge.players_count }} –∏–≥—Ä–æ–∫–æ–≤</span>
                                        {% if not badge.is_active %}
                                            <span class="badge bg-secondary ms-1">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="badge-actions mt-2">
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="assignBadge({{ badge.id }})">
                                        <i class="fas fa-user-plus"></i> –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning me-1" onclick="editBadge({{ badge.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {% if badge.is_active %}
                                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="toggleBadge({{ badge.id }}, false)">
                                            <i class="fas fa-eye-slash"></i>
                                        </button>
                                    {% else %}
                                        <button class="btn btn-sm btn-outline-success me-1" onclick="toggleBadge({{ badge.id }}, true)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    {% endif %}
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteBadge({{ badge.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-medal fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –±–µ–π–¥–∂–µ–π</h5>
                        <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –±–µ–π–¥–∂, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ</p>
                        <button class="btn btn-primary" onclick="document.getElementById('badge_display_name').focus()">
                            <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –±–µ–π–¥–∂
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Badge management functions
function assignBadge(badgeId) {
    const nickname = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –∏–≥—Ä–æ–∫–∞ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –±–µ–π–¥–∂–∞:');
    if (!nickname) return;

    fetch('/admin/assign_badge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `badge_id=${badgeId}&player_nickname=${encodeURIComponent(nickname)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –±–µ–π–¥–∂–∞', 'error');
    });
}

function editBadge(badgeId) {
    // Implement edit functionality
    showToast('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}

function toggleBadge(badgeId, isActive) {
    fetch('/admin/toggle_badge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `badge_id=${badgeId}&is_active=${isActive}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            location.reload();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
    });
}

function deleteBadge(badgeId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–µ–π–¥–∂? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }

    fetch('/admin/delete_badge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `badge_id=${badgeId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            location.reload();
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±–µ–π–¥–∂–∞', 'error');
    });
}

// Update emoji preview
document.addEventListener('DOMContentLoaded', function() {
    const emojiInput = document.getElementById('badge_emoji');
    const iconSelect = document.getElementById('badge_icon');
    const emojiClassInput = document.getElementById('badge_emoji_class');

    function updatePreview() {
        const preview = document.getElementById('badge_preview');
        if (!preview) return;

        const display = preview.querySelector('.badge-display');
        if (!display) return;

        // Update emoji
        let emojiDisplay = '';
        if (emojiInput && emojiInput.value) {
            emojiDisplay = emojiInput.value;
        } else if (emojiClassInput && emojiClassInput.value) {
            emojiDisplay = `<i class="${emojiClassInput.value}"></i>`;
        } else if (iconSelect && iconSelect.value) {
            emojiDisplay = `<i class="${iconSelect.value}"></i>`;
        }

        const emojiDisplayEl = display.querySelector('.emoji-display');
        const nameDisplayEl = display.querySelector('.name-display');

        if (emojiDisplayEl) emojiDisplayEl.innerHTML = emojiDisplay;
        if (nameDisplayEl) {
            const nameInput = document.getElementById('badge_display_name');
            nameDisplayEl.textContent = (nameInput ? nameInput.value : '') || '–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä';
        }
    }

    // Add event listeners
    emojiInput?.addEventListener('input', updatePreview);
    iconSelect?.addEventListener('change', updatePreview);
    emojiClassInput?.addEventListener('input', updatePreview);
    document.getElementById('badge_display_name')?.addEventListener('input', updatePreview);

    // Color inputs
    document.getElementById('badge_color')?.addEventListener('input', function() {
        const preview = document.getElementById('badge_preview');
        if (preview) {
            const display = preview.querySelector('.badge-display');
            if (display) display.style.color = this.value;
        }
    });

    document.getElementById('badge_background_color')?.addEventListener('input', function() {
        const preview = document.getElementById('badge_preview');
        if (preview) {
            const display = preview.querySelector('.badge-display');
            if (display) display.style.backgroundColor = this.value;
        }
    });

    document.getElementById('badge_border_color')?.addEventListener('input', function() {
        const preview = document.getElementById('badge_preview');
        if (preview) {
            const display = preview.querySelector('.badge-display');
            if (display) display.style.borderColor = this.value;
        }
    });

    // Initialize preview
    updatePreview();
});
</script>
{% endblock %}